# éäº¤æ˜“æ—¥æ•°æ®è´¨é‡è¯¯åˆ¤ä¿®å¤

**æ—¥æœŸ**: 2025-11-08
**ç‰ˆæœ¬**: v1.1.1
**é—®é¢˜ç±»å‹**: Bugä¿®å¤

---

## é—®é¢˜æè¿°

### ç°è±¡

åœ¨æŸ¥è¯¢è‚¡ç¥¨603579çš„æ•°æ®æ—¶ï¼Œè™½ç„¶æˆåŠŸè·å–äº†æ•°æ®ï¼ˆåŒ…å«ä»·æ ¼ã€æˆäº¤é‡ç­‰å®Œæ•´ä¿¡æ¯ï¼‰ï¼Œä½†ç³»ç»Ÿä»ç„¶æŠ¥å‘Š"æ•°æ®è´¨é‡å¼‚å¸¸"å¹¶å°è¯•é™çº§åˆ°å¤‡ç”¨æ•°æ®æºã€‚

### æ—¥å¿—ç¤ºä¾‹

```
âœ… æ‰¾åˆ°æˆäº¤é‡åˆ—: volume
âš ï¸ [æ•°æ®è·å–] æ•°æ®è´¨é‡å¼‚å¸¸ï¼Œå°è¯•é™çº§åˆ°å…¶ä»–æ•°æ®æº
ğŸ”„ tushareå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ•°æ®æº...
âš ï¸ å¤‡ç”¨æ•°æ®æºakshareè¿”å›é”™è¯¯ç»“æœ
âŒ [æ•°æ®è·å–] æ‰€æœ‰æ•°æ®æºéƒ½æ— æ³•è·å–æœ‰æ•ˆæ•°æ®
```

### å®é™…è¿”å›çš„æ•°æ®

```
ğŸ“Š è£æ³°å¥åº·(603579) - Tushareæ•°æ®
æ•°æ®æœŸé—´: 2025-11-08 è‡³ 2025-11-08
æ•°æ®æ¡æ•°: 1æ¡

ğŸ• å½“å‰æ—¶é—´: 2025-11-08 00:43:32
â° äº¤æ˜“çŠ¶æ€: âŒ éäº¤æ˜“æ—¥ï¼ˆå‘¨å…­ï¼‰
ğŸ’¹ ä»·æ ¼ç±»å‹: ä»Šæ—¥æ”¶ç›˜ä»·

ğŸ’° æœ€æ–°ä»·æ ¼: Â¥26.48 (ä»Šæ—¥æ”¶ç›˜ä»·)
ğŸ“ˆ æ¶¨è·Œé¢: +0.00 (+0.00%)
```

å¯ä»¥çœ‹åˆ°æ•°æ®æ˜¯å®Œæ•´çš„ï¼Œåªæ˜¯å› ä¸ºæŸ¥è¯¢æ—¥æœŸæ˜¯å‘¨å…­ï¼ˆéäº¤æ˜“æ—¥ï¼‰ï¼ŒçŠ¶æ€æ˜¾ç¤ºä¸º"âŒ éäº¤æ˜“æ—¥ï¼ˆå‘¨å…­ï¼‰"ã€‚

---

## é—®é¢˜æ ¹æº

### åŸæœ‰çš„é”™è¯¯åˆ¤æ–­é€»è¾‘

åœ¨`tradingagents/dataflows/data_source_manager.py`ä¸­ï¼Œæœ‰3å¤„åœ°æ–¹ä½¿ç”¨äº†è¿‡äºç®€å•çš„é”™è¯¯åˆ¤æ–­ï¼š

#### ä½ç½®1: ä¸»è¦æ•°æ®è·å–åˆ¤æ–­ï¼ˆç¬¬320è¡Œï¼‰

```python
# âŒ æ—§é€»è¾‘
is_success = result and "âŒ" not in result and "é”™è¯¯" not in result
```

**é—®é¢˜**ï¼šåªè¦ç»“æœä¸­åŒ…å«"âŒ"ç¬¦å·ï¼Œå°±ä¼šè¢«åˆ¤å®šä¸ºå¤±è´¥ã€‚

#### ä½ç½®2: é™çº§åˆ¤æ–­ï¼ˆç¬¬363è¡Œï¼‰

```python
# âŒ æ—§é€»è¾‘
if fallback_result and "âŒ" not in fallback_result and "é”™è¯¯" not in fallback_result:
```

#### ä½ç½®3: å¤‡ç”¨æ•°æ®æºåˆ¤æ–­ï¼ˆç¬¬653è¡Œï¼‰

```python
# âŒ æ—§é€»è¾‘
if "âŒ" not in result:
```

### ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Ÿ

ç³»ç»Ÿåœ¨è¿”å›æ•°æ®æ—¶ï¼Œä½¿ç”¨"âŒ"ç¬¦å·æ ‡è®°éäº¤æ˜“çŠ¶æ€ï¼š

```python
# data_source_manager.py:420
result += f"â° äº¤æ˜“çŠ¶æ€: {'âœ… ' + time_status if is_trading else 'âŒ ' + time_status}\n"
```

è¿™å¯¼è‡´åœ¨å‘¨æœ«ã€èŠ‚å‡æ—¥ç­‰éäº¤æ˜“æ—¶é—´æŸ¥è¯¢æ—¶ï¼Œè¿”å›çš„æ•°æ®ä¼šåŒ…å«"âŒ éäº¤æ˜“æ—¥"çš„çŠ¶æ€æç¤ºã€‚ä½†è¿™**ä¸æ˜¯é”™è¯¯**ï¼Œåªæ˜¯ä¸€ä¸ª**çŠ¶æ€è¯´æ˜**ã€‚

---

## ä¿®å¤æ–¹æ¡ˆ

### æ”¹è¿›çš„é”™è¯¯åˆ¤æ–­é€»è¾‘

ä½¿ç”¨æ›´ç²¾ç¡®çš„é”™è¯¯æ£€æµ‹ï¼Œåªåˆ¤æ–­çœŸæ­£çš„é”™è¯¯æ ‡è®°ï¼š

```python
# âœ… æ–°é€»è¾‘
has_data_error = (
    "âŒ æœªè·å–åˆ°" in result or      # æ˜ç¡®çš„æ•°æ®è·å–å¤±è´¥
    "âŒ é”™è¯¯" in result or            # æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
    "âŒ [æ•°æ®è·å–]" in result or     # æ•°æ®è·å–æ¨¡å—çš„é”™è¯¯
    "âŒ æ•°æ®ä¸ºç©º" in result or       # æ•°æ®ä¸ºç©º
    "è·å–å¤±è´¥" in result or          # å¤±è´¥æ ‡è®°
    "æ•°æ®æºå¼‚å¸¸" in result           # æ•°æ®æºå¼‚å¸¸
)
is_success = result and not has_data_error
```

### ä¿®å¤çš„3ä¸ªä½ç½®

#### 1. ä¸»è¦æ•°æ®è·å–åˆ¤æ–­ï¼ˆdata_source_manager.py:321-333ï¼‰

```python
# ğŸ”§ æ”¹è¿›çš„æˆåŠŸåˆ¤æ–­é€»è¾‘ï¼š
# 1. ç»“æœä¸ä¸ºç©º
# 2. ä¸åŒ…å«æ˜ç¡®çš„é”™è¯¯æ ‡è®°ï¼ˆä½†å…è®¸äº¤æ˜“çŠ¶æ€æ ‡è®°ï¼‰
# 3. å…è®¸"âŒ éäº¤æ˜“æ—¥"ç­‰çŠ¶æ€æç¤º
has_data_error = (
    "âŒ æœªè·å–åˆ°" in result or
    "âŒ é”™è¯¯" in result or
    "âŒ [æ•°æ®è·å–]" in result or
    "âŒ æ•°æ®ä¸ºç©º" in result or
    "è·å–å¤±è´¥" in result or
    "æ•°æ®æºå¼‚å¸¸" in result
)
is_success = result and not has_data_error
```

#### 2. é™çº§åˆ¤æ–­ï¼ˆdata_source_manager.py:364-372ï¼‰

```python
# ğŸ”§ ä½¿ç”¨ç›¸åŒçš„é”™è¯¯åˆ¤æ–­é€»è¾‘
has_fallback_error = fallback_result and (
    "âŒ æœªè·å–åˆ°" in fallback_result or
    "âŒ é”™è¯¯" in fallback_result or
    "âŒ [æ•°æ®è·å–]" in fallback_result or
    "âŒ æ•°æ®ä¸ºç©º" in fallback_result or
    "è·å–å¤±è´¥" in fallback_result or
    "æ•°æ®æºå¼‚å¸¸" in fallback_result
)

if fallback_result and not has_fallback_error:
    logger.info(f"âœ… [æ•°æ®è·å–] é™çº§æˆåŠŸè·å–æ•°æ®")
    return fallback_result
```

#### 3. å¤‡ç”¨æ•°æ®æºåˆ¤æ–­ï¼ˆdata_source_manager.py:653-661ï¼‰

```python
# ğŸ”§ ä½¿ç”¨ç›¸åŒçš„é”™è¯¯åˆ¤æ–­é€»è¾‘
has_error = (
    "âŒ æœªè·å–åˆ°" in result or
    "âŒ é”™è¯¯" in result or
    "âŒ [æ•°æ®è·å–]" in result or
    "âŒ æ•°æ®ä¸ºç©º" in result or
    "è·å–å¤±è´¥" in result or
    "æ•°æ®æºå¼‚å¸¸" in result
)

if not has_error:
    logger.info(f"âœ… å¤‡ç”¨æ•°æ®æº{source.value}è·å–æˆåŠŸ")
    return result
```

---

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

```
âœ… æ‰¾åˆ°æˆäº¤é‡åˆ—: volume
âš ï¸ [æ•°æ®è·å–] æ•°æ®è´¨é‡å¼‚å¸¸ï¼Œå°è¯•é™çº§åˆ°å…¶ä»–æ•°æ®æº
ğŸ”„ tushareå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ•°æ®æº...
âš ï¸ å¤‡ç”¨æ•°æ®æºakshareè¿”å›é”™è¯¯ç»“æœ
âŒ [æ•°æ®è·å–] æ‰€æœ‰æ•°æ®æºéƒ½æ— æ³•è·å–æœ‰æ•ˆæ•°æ®
âš ï¸ [ç»Ÿä¸€æ¥å£] ä¸­å›½è‚¡ç¥¨æ•°æ®è´¨é‡å¼‚å¸¸
```

### ä¿®å¤å

```
âœ… æ‰¾åˆ°æˆäº¤é‡åˆ—: volume
âœ… [æ•°æ®è·å–] æˆåŠŸè·å–è‚¡ç¥¨æ•°æ®
ğŸ“Š è£æ³°å¥åº·(603579) - Tushareæ•°æ®
â° äº¤æ˜“çŠ¶æ€: âŒ éäº¤æ˜“æ—¥ï¼ˆå‘¨å…­ï¼‰
ğŸ’° æœ€æ–°ä»·æ ¼: Â¥26.48
```

---

## å½±å“èŒƒå›´

### âœ… ç°åœ¨å¯ä»¥æ­£ç¡®å¤„ç†çš„æƒ…å†µ

1. **éäº¤æ˜“æ—¥æŸ¥è¯¢**ï¼šå‘¨æœ«ã€èŠ‚å‡æ—¥æŸ¥è¯¢ä¼šæ­£ç¡®è¿”å›æ•°æ®ï¼Œä¸ä¼šè¯¯åˆ¤ä¸ºå¤±è´¥
2. **éäº¤æ˜“æ—¶æ®µæŸ¥è¯¢**ï¼šç›˜å‰ã€ç›˜åã€åˆä¼‘æ—¶æ®µæŸ¥è¯¢æ­£å¸¸
3. **åœç‰Œè‚¡ç¥¨**ï¼šåœç‰ŒçŠ¶æ€çš„è‚¡ç¥¨å¯ä»¥æ­£å¸¸è¿”å›å†å²æ•°æ®
4. **æ–°è‚¡ä¸Šå¸‚**ï¼šä¸Šå¸‚é¦–æ—¥å‰çš„æŸ¥è¯¢ä¸ä¼šè¢«è¯¯åˆ¤

### âš ï¸ ä»ä¼šè¢«åˆ¤å®šä¸ºé”™è¯¯çš„æƒ…å†µ

ä»¥ä¸‹æƒ…å†µä¼šæ­£ç¡®åœ°è¢«åˆ¤å®šä¸ºé”™è¯¯ï¼š

1. è‚¡ç¥¨ä»£ç ä¸å­˜åœ¨ï¼š`âŒ æœªè·å–åˆ°603579çš„æœ‰æ•ˆæ•°æ®`
2. æ•°æ®æºå¼‚å¸¸ï¼š`âŒ é”™è¯¯: ç½‘ç»œè¿æ¥å¤±è´¥`
3. APIé™åˆ¶ï¼š`âŒ [æ•°æ®è·å–] APIè°ƒç”¨è¶…é™`
4. æ•°æ®ä¸ºç©ºï¼š`âŒ æ•°æ®ä¸ºç©ºï¼Œè¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç `

---

## æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯1: éäº¤æ˜“æ—¥æŸ¥è¯¢

```bash
# åœ¨å‘¨æœ«æŸ¥è¯¢è‚¡ç¥¨
curl -X POST http://localhost:8000/api/v1/agents/analyze-all/603579
```

**é¢„æœŸç»“æœ**:
- âœ… ä¸ä¼šå‡ºç°"æ•°æ®è´¨é‡å¼‚å¸¸"è­¦å‘Š
- âœ… ä¸ä¼šå°è¯•é™çº§åˆ°å¤‡ç”¨æ•°æ®æº
- âœ… è¿”å›å®Œæ•´çš„æ•°æ®ï¼ˆåŒ…å«äº¤æ˜“çŠ¶æ€æ ‡è®°ï¼‰

### æµ‹è¯•åœºæ™¯2: äº¤æ˜“æ—¥æŸ¥è¯¢

```bash
# åœ¨å·¥ä½œæ—¥äº¤æ˜“æ—¶æ®µæŸ¥è¯¢
curl -X POST http://localhost:8000/api/v1/agents/analyze-all/603579
```

**é¢„æœŸç»“æœ**:
- âœ… æ­£å¸¸è·å–å®æ—¶æ•°æ®
- âœ… äº¤æ˜“çŠ¶æ€æ˜¾ç¤ºä¸º"âœ… äº¤æ˜“ä¸­"æˆ–ç›¸åº”çš„æ—¶æ®µ

### æµ‹è¯•åœºæ™¯3: é”™è¯¯ä»£ç æŸ¥è¯¢

```bash
# æŸ¥è¯¢ä¸å­˜åœ¨çš„è‚¡ç¥¨ä»£ç 
curl -X POST http://localhost:8000/api/v1/agents/analyze-all/999999
```

**é¢„æœŸç»“æœ**:
- âœ… æ­£ç¡®è¯†åˆ«ä¸ºé”™è¯¯
- âœ… å°è¯•é™çº§åˆ°å¤‡ç”¨æ•°æ®æº
- âœ… æœ€ç»ˆè¿”å›"æœªè·å–åˆ°æœ‰æ•ˆæ•°æ®"

---

## ç›¸å…³æ–‡ä»¶

- **ä¿®æ”¹æ–‡ä»¶**: `tradingagents/dataflows/data_source_manager.py`
- **ä¿®æ”¹è¡Œæ•°**: 3å¤„
  - ç¬¬321-333è¡Œï¼šä¸»è¦æ•°æ®è·å–åˆ¤æ–­
  - ç¬¬364-372è¡Œï¼šé™çº§åˆ¤æ–­
  - ç¬¬653-661è¡Œï¼šå¤‡ç”¨æ•°æ®æºåˆ¤æ–­

---

## æŠ€æœ¯ç»†èŠ‚

### é”™è¯¯æ ‡è®°æ¸…å•

ç³»ç»Ÿä¸­å®šä¹‰çš„çœŸæ­£çš„é”™è¯¯æ ‡è®°ï¼ˆä¼šè§¦å‘å¤±è´¥åˆ¤æ–­ï¼‰ï¼š

| é”™è¯¯æ ‡è®° | å«ä¹‰ | ç¤ºä¾‹ |
|---------|------|------|
| `âŒ æœªè·å–åˆ°` | æ•°æ®è·å–å¤±è´¥ | `âŒ æœªè·å–åˆ°603579çš„æœ‰æ•ˆæ•°æ®` |
| `âŒ é”™è¯¯` | æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯ | `âŒ é”™è¯¯: ç½‘ç»œè¿æ¥è¶…æ—¶` |
| `âŒ [æ•°æ®è·å–]` | æ•°æ®è·å–æ¨¡å—é”™è¯¯ | `âŒ [æ•°æ®è·å–] APIè°ƒç”¨å¤±è´¥` |
| `âŒ æ•°æ®ä¸ºç©º` | è¿”å›æ•°æ®ä¸ºç©º | `âŒ æ•°æ®ä¸ºç©ºï¼Œè¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç ` |
| `è·å–å¤±è´¥` | é€šç”¨å¤±è´¥æ ‡è®° | `æ•°æ®è·å–å¤±è´¥ï¼šAPIé™åˆ¶` |
| `æ•°æ®æºå¼‚å¸¸` | æ•°æ®æºå¼‚å¸¸ | `æ•°æ®æºå¼‚å¸¸ï¼šTushareæœåŠ¡ä¸å¯ç”¨` |

### å…è®¸çš„çŠ¶æ€æ ‡è®°

ä»¥ä¸‹æ ‡è®°ä¸ä¼šè¢«åˆ¤å®šä¸ºé”™è¯¯ï¼š

| çŠ¶æ€æ ‡è®° | å«ä¹‰ | ç¤ºä¾‹ |
|---------|------|------|
| `âŒ éäº¤æ˜“æ—¥` | éäº¤æ˜“æ—¥çŠ¶æ€ | `â° äº¤æ˜“çŠ¶æ€: âŒ éäº¤æ˜“æ—¥ï¼ˆå‘¨å…­ï¼‰` |
| `âŒ ç›˜å‰` | ç›˜å‰æ—¶æ®µ | `â° äº¤æ˜“çŠ¶æ€: âŒ ç›˜å‰ï¼ˆ08:30ï¼‰` |
| `âŒ ç›˜å` | ç›˜åæ—¶æ®µ | `â° äº¤æ˜“çŠ¶æ€: âŒ ç›˜åï¼ˆ15:30ï¼‰` |
| `âŒ åˆä¼‘` | åˆä¼‘æ—¶æ®µ | `â° äº¤æ˜“çŠ¶æ€: âŒ åˆä¼‘ï¼ˆ12:00ï¼‰` |
| `âŒ åœç‰Œ` | è‚¡ç¥¨åœç‰Œ | `ğŸ“Š äº¤æ˜“çŠ¶æ€: âŒ åœç‰Œ` |

---

## åç»­ä¼˜åŒ–å»ºè®®

1. **ç»Ÿä¸€é”™è¯¯æ ‡è®°è§„èŒƒ**ï¼š
   - å»ºç«‹ç»Ÿä¸€çš„é”™è¯¯ä»£ç ä½“ç³»
   - åŒºåˆ†é”™è¯¯ã€è­¦å‘Šã€çŠ¶æ€
   - ä½¿ç”¨ä¸åŒçš„ç¬¦å·æ ‡è®°ï¼ˆå¦‚âŒ=é”™è¯¯ï¼Œâš ï¸=è­¦å‘Šï¼Œâ„¹ï¸=çŠ¶æ€ï¼‰

2. **ç»“æ„åŒ–è¿”å›**ï¼š
   - è€ƒè™‘ä½¿ç”¨JSONæ ¼å¼è¿”å›ï¼ŒåŒ…å«statuså­—æ®µ
   - æ˜ç¡®åŒºåˆ†dataå’Œmetadata
   ```python
   {
       "status": "success",
       "data": {...},
       "metadata": {
           "is_trading_day": false,
           "market_status": "closed"
       }
   }
   ```

3. **æ·»åŠ å•å…ƒæµ‹è¯•**ï¼š
   - æµ‹è¯•éäº¤æ˜“æ—¥åœºæ™¯
   - æµ‹è¯•çœŸå®é”™è¯¯åœºæ™¯
   - ç¡®ä¿åˆ¤æ–­é€»è¾‘çš„å‡†ç¡®æ€§

---

## ç›¸å…³é—®é¢˜ä¿®å¤

è¿™æ¬¡ä¿®å¤åŒæ—¶è§£å†³äº†ä»¥ä¸‹ç›¸å…³é—®é¢˜ï¼š

1. âœ… èŠ‚å‡æ—¥æŸ¥è¯¢è¢«è¯¯åˆ¤ä¸ºé”™è¯¯
2. âœ… ç›˜å‰ç›˜åæŸ¥è¯¢è¢«é™çº§åˆ°å¤‡ç”¨æ•°æ®æº
3. âœ… åœç‰Œè‚¡ç¥¨æŸ¥è¯¢è¢«åˆ¤å®šä¸ºæ•°æ®è´¨é‡å¼‚å¸¸
4. âœ… åˆä¼‘æ—¶æ®µæŸ¥è¯¢è§¦å‘ä¸å¿…è¦çš„é™çº§

---

**ç»´æŠ¤è€…**: Claude Code
**å®¡æ ¸çŠ¶æ€**: å·²ä¿®å¤
**éƒ¨ç½²çŠ¶æ€**: å¾…æµ‹è¯•

---

# éäº¤æ˜“æ—¥è‡ªåŠ¨é™çº§åŠŸèƒ½ï¼ˆ2025-11-08 æ–°å¢ï¼‰

## åŠŸèƒ½èƒŒæ™¯

åœ¨ä¹‹å‰çš„ä¿®å¤ä¸­ï¼Œæˆ‘ä»¬è§£å†³äº†éäº¤æ˜“æ—¥æ•°æ®è¢«è¯¯åˆ¤ä¸ºé”™è¯¯çš„é—®é¢˜ã€‚ä½†ç”¨æˆ·ä»ç„¶éœ€è¦æ‰‹åŠ¨åˆ¤æ–­äº¤æ˜“æ—¥å¹¶è°ƒæ•´æŸ¥è¯¢æ—¥æœŸã€‚

ä¸ºäº†è¿›ä¸€æ­¥ä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼Œæˆ‘ä»¬æ–°å¢äº†**éäº¤æ˜“æ—¥è‡ªåŠ¨é™çº§**åŠŸèƒ½ã€‚

## åŠŸèƒ½æè¿°

å½“ç”¨æˆ·è¯·æ±‚éäº¤æ˜“æ—¥ï¼ˆå‘¨æœ«ã€èŠ‚å‡æ—¥ï¼‰çš„æ•°æ®æ—¶ï¼Œç³»ç»Ÿä¼šï¼š

1. âœ… è‡ªåŠ¨æ£€æµ‹è¯¥æ—¥æœŸæ˜¯å¦ä¸ºäº¤æ˜“æ—¥
2. âœ… å¦‚æœæ˜¯éäº¤æ˜“æ—¥ï¼Œè‡ªåŠ¨ä½¿ç”¨æœ€è¿‘çš„ä¸Šä¸€ä¸ªäº¤æ˜“æ—¥
3. âœ… åœ¨è¿”å›æ•°æ®ä¸­æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·ä½¿ç”¨äº†å“ªä¸ªäº¤æ˜“æ—¥çš„æ•°æ®

### ä½¿ç”¨ç¤ºä¾‹

```python
from tradingagents.dataflows.data_source_manager import get_data_source_manager

manager = get_data_source_manager()

# ç”¨æˆ·è¯·æ±‚å‘¨å…­çš„æ•°æ®
result = manager.get_stock_data(
    symbol="002215.SZ",
    start_date="2025-11-01",
    end_date="2025-11-08"  # å‘¨å…­
)

# ç³»ç»Ÿè‡ªåŠ¨å¤„ç†ï¼š
# 1. æ£€æµ‹åˆ° 2025-11-08 æ˜¯å‘¨å…­ï¼ˆéäº¤æ˜“æ—¥ï¼‰
# 2. è‡ªåŠ¨ä½¿ç”¨ 2025-11-07ï¼ˆå‘¨äº”ï¼‰çš„æ•°æ®
# 3. åœ¨è¿”å›æ•°æ®ä¸­æ·»åŠ æç¤º
```

### è¿”å›ç»“æœç¤ºä¾‹

```
âš ï¸ æ³¨æ„ï¼šæ‚¨è¯·æ±‚çš„æ—¥æœŸ 2025-11-08 æ˜¯éäº¤æ˜“æ—¥ï¼Œç³»ç»Ÿå·²è‡ªåŠ¨ä½¿ç”¨ä¸Šä¸€ä¸ªäº¤æ˜“æ—¥ 2025-11-07 çš„æ•°æ®ã€‚

ğŸ“Š è¯ºæ™®ä¿¡(002215.SZ) - Tushareæ•°æ®
æ•°æ®æœŸé—´: 2025-11-01 è‡³ 2025-11-07
æ•°æ®æ¡æ•°: 5æ¡

ğŸ• å½“å‰æ—¶é—´: 2025-11-08 20:44:38
â° äº¤æ˜“çŠ¶æ€: âŒ éäº¤æ˜“æ—¥ï¼ˆå‘¨å…­ï¼‰
ğŸ’¹ ä»·æ ¼ç±»å‹: ä»Šæ—¥æ”¶ç›˜ä»·

ğŸ’° æœ€æ–°ä»·æ ¼: Â¥15.23 (ä»Šæ—¥æ”¶ç›˜ä»·)
ğŸ“ˆ æ¶¨è·Œé¢: +0.12 (+0.79%)
...
```

## æŠ€æœ¯å®ç°

### 1. æ–°å¢äº¤æ˜“æ—¥æ£€æµ‹å‡½æ•°

åœ¨ `tradingagents/utils/market_context.py` ä¸­æ–°å¢ï¼š

```python
@staticmethod
def is_trading_day(check_date: datetime = None) -> bool:
    """åˆ¤æ–­æ˜¯å¦ä¸ºäº¤æ˜“æ—¥ï¼ˆä»…æ£€æŸ¥å‘¨æœ«ï¼‰"""
    if check_date is None:
        check_date = datetime.now()

    weekday = check_date.weekday()
    # 0=å‘¨ä¸€, 1=å‘¨äºŒ, ..., 5=å‘¨å…­, 6=å‘¨æ—¥
    # å‘¨æœ«ä¸æ˜¯äº¤æ˜“æ—¥
    return weekday < 5

@staticmethod
def get_previous_trading_day(from_date: datetime = None, max_lookback: int = 7) -> Optional[str]:
    """è·å–æŒ‡å®šæ—¥æœŸä¹‹å‰çš„æœ€è¿‘ä¸€ä¸ªäº¤æ˜“æ—¥"""
    if from_date is None:
        from_date = datetime.now()

    # ä»å‰ä¸€å¤©å¼€å§‹æŸ¥æ‰¾
    check_date = from_date - timedelta(days=1)

    for _ in range(max_lookback):
        if MarketContext.is_trading_day(check_date):
            result_date = check_date.strftime('%Y-%m-%d')
            logger.info(f"ğŸ“… [äº¤æ˜“æ—¥æ£€æµ‹] {from_date.strftime('%Y-%m-%d')} çš„ä¸Šä¸€ä¸ªäº¤æ˜“æ—¥æ˜¯ {result_date}")
            return result_date

        check_date -= timedelta(days=1)

    # æœªæ‰¾åˆ°äº¤æ˜“æ—¥
    logger.warning(f"âš ï¸ [äº¤æ˜“æ—¥æ£€æµ‹] åœ¨{max_lookback}å¤©å†…æœªæ‰¾åˆ°{from_date.strftime('%Y-%m-%d')}ä¹‹å‰çš„äº¤æ˜“æ—¥")
    return None
```

### 2. æ•°æ®è·å–é€»è¾‘æ”¹è¿›

åœ¨ `tradingagents/dataflows/data_source_manager.py` çš„ `get_stock_data()` æ–¹æ³•ä¸­æ·»åŠ ï¼š

```python
def get_stock_data(self, symbol: str, start_date: str = None, end_date: str = None) -> str:
    # å¯¼å…¥äº¤æ˜“æ—¥æ£€æµ‹æ¨¡å—
    from tradingagents.utils.market_context import MarketContext
    from datetime import datetime

    # ğŸ†• äº¤æ˜“æ—¥æ£€æµ‹ï¼šæ£€æŸ¥end_dateæ˜¯å¦ä¸ºäº¤æ˜“æ—¥
    original_end_date = end_date
    used_fallback_date = False

    if end_date:
        try:
            end_date_obj = datetime.strptime(end_date, '%Y-%m-%d')
            is_trading_day = MarketContext.is_trading_day(end_date_obj)

            if not is_trading_day:
                # éäº¤æ˜“æ—¥ï¼Œè‡ªåŠ¨ä½¿ç”¨ä¸Šä¸€ä¸ªäº¤æ˜“æ—¥
                previous_trading_day = MarketContext.get_previous_trading_day(end_date_obj)

                if previous_trading_day:
                    logger.info(f"ğŸ“… [éäº¤æ˜“æ—¥å¤„ç†] {end_date} æ˜¯éäº¤æ˜“æ—¥ï¼Œè‡ªåŠ¨ä½¿ç”¨ä¸Šä¸€ä¸ªäº¤æ˜“æ—¥: {previous_trading_day}")
                    end_date = previous_trading_day
                    used_fallback_date = True
                else:
                    logger.warning(f"âš ï¸ [éäº¤æ˜“æ—¥å¤„ç†] {end_date} æ˜¯éäº¤æ˜“æ—¥ï¼Œä½†æœªæ‰¾åˆ°ä¸Šä¸€ä¸ªäº¤æ˜“æ—¥ï¼Œå°†ç»§ç»­å°è¯•")

        except ValueError as e:
            logger.warning(f"âš ï¸ [äº¤æ˜“æ—¥æ£€æµ‹] æ—¥æœŸæ ¼å¼é”™è¯¯: {end_date}, {e}")

    # ... åŸæœ‰æ•°æ®è·å–é€»è¾‘ ...

    # ğŸ†• åœ¨ç»“æœä¸­æ·»åŠ éäº¤æ˜“æ—¥æç¤º
    if used_fallback_date and result and not result.startswith('âŒ'):
        non_trading_notice = f"\n\nâš ï¸ æ³¨æ„ï¼šæ‚¨è¯·æ±‚çš„æ—¥æœŸ {original_end_date} æ˜¯éäº¤æ˜“æ—¥ï¼Œç³»ç»Ÿå·²è‡ªåŠ¨ä½¿ç”¨ä¸Šä¸€ä¸ªäº¤æ˜“æ—¥ {end_date} çš„æ•°æ®ã€‚\n"
        result = non_trading_notice + result

    return result
```

## åŠŸèƒ½ç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ |
|-----|------|
| âœ… è‡ªåŠ¨æ£€æµ‹ | æ— éœ€æ‰‹åŠ¨åˆ¤æ–­æ˜¯å¦ä¸ºäº¤æ˜“æ—¥ |
| âœ… æ™ºèƒ½é™çº§ | è‡ªåŠ¨ä½¿ç”¨æœ€è¿‘çš„äº¤æ˜“æ—¥æ•°æ® |
| âœ… å‹å¥½æç¤º | æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·ä½¿ç”¨äº†å“ªä¸ªæ—¥æœŸçš„æ•°æ® |
| âœ… å‘åå…¼å®¹ | ä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼Œäº¤æ˜“æ—¥è¯·æ±‚è¡Œä¸ºä¸å˜ |
| âœ… æœ€å¤§å›æº¯7å¤© | é¿å…æ— é™æŸ¥æ‰¾ï¼ˆé˜²æ­¢é•¿å‡æœŸå¯¼è‡´çš„é—®é¢˜ï¼‰ |

## é™åˆ¶è¯´æ˜

1. **ä»…æ£€æŸ¥å‘¨æœ«**ï¼šç›®å‰åªæ£€æµ‹å‘¨å…­ã€å‘¨æ—¥ï¼Œä¸åŒ…æ‹¬æ³•å®šèŠ‚å‡æ—¥
2. **æœ€å¤§å›æº¯7å¤©**ï¼šå¦‚æœ7å¤©å†…éƒ½æ²¡æœ‰äº¤æ˜“æ—¥ï¼Œä¼šè¿”å›è­¦å‘Š
3. **ä»…å½±å“ end_date**ï¼šåªå¯¹ç»“æŸæ—¥æœŸè¿›è¡Œæ£€æµ‹å’Œé™çº§ï¼Œstart_date ä¸å˜

## æµ‹è¯•ç»“æœ

```bash
[TEST] Testing non-trading day auto-fallback
============================================================
Test 1: 2025-11-08 is trading day? False
[PASS] Trading day detection works

Test 2: Previous trading day of 2025-11-08 is 2025-11-07
[PASS] Previous trading day calculation works

Test 3: Data fetch with non-trading day
  Result length: 374 chars
  Has non-trading day notice: True
  Has valid data: True
[PASS] Non-trading day auto-fallback works
[PASS] Data fetch successful
```

## ç›¸å…³æ–‡ä»¶ä¿®æ”¹

- âœ… `tradingagents/utils/market_context.py` - æ–°å¢äº¤æ˜“æ—¥æ£€æµ‹å‡½æ•°
- âœ… `tradingagents/dataflows/data_source_manager.py` - æ•°æ®è·å–é€»è¾‘æ”¹è¿›

## æœªæ¥æ”¹è¿›æ–¹å‘

1. **èŠ‚å‡æ—¥æ”¯æŒ**ï¼šé›†æˆä¸­å›½æ³•å®šèŠ‚å‡æ—¥æ—¥å†ï¼ˆä½¿ç”¨ chinese_calendar åº“ï¼‰
2. **å¤šå¸‚åœºæ”¯æŒ**ï¼šæ”¯æŒæ¸¯è‚¡ã€ç¾è‚¡ç­‰ä¸åŒå¸‚åœºçš„äº¤æ˜“æ—¥å†
3. **ç¼“å­˜ä¼˜åŒ–**ï¼šç¼“å­˜äº¤æ˜“æ—¥å†ï¼Œå‡å°‘é‡å¤è®¡ç®—
4. **é…ç½®åŒ–**ï¼šå…è®¸ç”¨æˆ·é€‰æ‹©æ˜¯å¦å¯ç”¨è‡ªåŠ¨é™çº§åŠŸèƒ½

---

**å®ç°æ—¥æœŸ**: 2025-11-08
**æµ‹è¯•çŠ¶æ€**: å·²é€šè¿‡
**éƒ¨ç½²çŠ¶æ€**: å·²å®Œæˆ
